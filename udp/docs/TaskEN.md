# Homework #2 - UDP client


## Situation

A probe is flying in orbit around Mars to collect information and
photos from the robots working at the planet surface (see Task 1).
The information obtained is then transmitted from the probe
to the control center on the Earth.


## Tasks

Your task is:

1. retrieve the last known photo of the surroundings from the probe so
scientists can find out the terrain where the robots are

1. upload new firmware to probe


## General communication scheme

The probe communicates via UDP and receives data on port 4000.
The process running on the probe is called the server and
the process that communicates with the probe is the client.


### Packet format

| identifier of ‚connection‘ | sequence number | acknowledgment number  | flag | data   |
|----------------------------|-----------------|------------------------|------|--------|
| 4B                         | 2B              | 2B                     | 1B   | 0-255B |

- identifier of ‚connection‘ - generated by server
(to allow data of multiple files to be transported at once),

- sequence number - number of the first byte in the sent data,

- acknowledgment number - number of expected byte in receiving data,

- flag - described below,

- data - transmitted data

Identifier of ‚connection‘ and sequence number are transmitted in
network byte order representation (big endian). Example:

| decimal   | hexadecimal   | order of bytes |
|-----------|---------------|----------------|
| 1234      | 04D2h         | 04h D2h        |
| 34566     | 8706h         | 8706h          |



### Identifier of ‚connection‘

Identifier of ‚connection‘ is non-zero number.
When establishing a connection, the client sends a connection identifier set to zero.
In further communication, the client uses the connection identifier
that the server returns to it in the first packet.


|  bit number | 7 | 6 | 5 | 4 | 3 |  2  |  1  |  0  |
|-------------|---|---|---|---|---|-----|-----|-----|
|  flag       | - | - | - | - | - | SYN | FIN | RST |



| flag | description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| SYN  | Open a new connection. It is sent by both the client and the server  (only) at the beginning of communication in the first packet. There must  be just 1 byte with the command code in the data field.                                                                                                                                                                                                                                                                                                                                                                                           |
| FIN  | Close the connection. It is sent by both the client and the server if they no  longer have any other data to send. A packet with the FIN flag set can  no longer contain any data. The termination of the connection cannot be  revoked. Both directions of connection are closed separately. Sequence  number must not be increased after sending FIN.                                                                                                                                                                                                                                          |
| RST  | Canceling a connection due to an error. It is sent by both the client  and server when a logical error in values in the header is detected.  E.g. the received packet does not contain the SYN flag and the  connection ID is not registered. Or, the acknowledgment number is less  than in the last received packet (decreases). Beware of overflowing of  sequence and acknowledgment numbers. None of the communicating parties  no longer terminates the connection in the standard way after sending  the RST packet - the connection is terminated by transmitting packet  with RST flag. |

Individual flags (SYN, FIN, RST) cannot be combined.


### Sequence number and acknowledgment number

Sequence number is the sequential number of the first byte in the stream of sent data.
Initially, this number is set to zero.
The SYN or FIN flag setting does not change this number.

The acknowledgment number tells the counterparty the sequential number
of the expected byte in the stream of received data.
It also confirms all bytes with a lower sequential number.

These numbers don’t have a sign and can overflow. Overflow does not affect communication.


### Data

The data length is determined by the packet size minus the header size.
A maximum of 255 bytes of data can be sent at a time,
so the smallest datagram size is 9B (header only) and the largest is 9 + 255 = 264B.
Data can only be sent in a packet without the FIN and RST flag set.
If the SYN flag is set to the packet,
there must be 1 byte with the command code in the data part.

The data sent by both the client and the server is
numbered using a sequence number, but only if no flag is set (especially SYN).

## Protocol description

### Connection establishment

The initiator of the connection is always the client.

The client sends the first datagram with the SYN flag and with the
connection identifier, sequence number,
and acknowledgment number set to zero.
The data part must contain just 1 byte with the command code:

| command | description                       |
|---------|-----------------------------------|
| 01h     | Download foto of the surroundings |
| 02h     | Upload of new firmware            |

The server responds with a datagram with the SYN flag set,
a nonzero connection identifier, and a sequence number and
acknowledgment number set to zero.
The data part contains 1 byte with the command code to be executed.

After receiving of this datagram by the client, a connection is established.
In the next packet, the client or the server starts sending data (according to the command sent).

If the SYN flagged packet sent by the client is lost, the client must send a new one after 100 ms.

If a SYN packet sent by the server is lost, the client must send a new SYN packet after 100 ms.
In the case of download, the server will probably start sending data,
but the client does not know the connection number and thus cannot receive the data.
This server’s half-open connection is closed after the 20th repetition of the same packet
(a packet with the RST flag and the connection identifier set will be sent).
In case of upload, this connection is closed after the 20th repetition of the SYN packet.

*Note: Data sent by the server will certainly be delivered to the client
which requested the connection. So it would seem that in the case of download,
the server does not need to send a packet with the SYN flag
(it could send a part of the data straight away).
However, because the client can establish multiple connections at the same time,
i.e. send multiple initialization packets at once (e.g. with different commands),
the client must wait for the SYN packet with the connection number.
After that it can assign connection numbers correctly according to the command code
(in the data field in the from the server).*

## Data transfer

Data can only be sent after a connection has been established.
Sending data is incompatible with setting any flags (SYN, RST, FIN)
(in this terminology we do not take the command in the first packet sent
by the client as data).
In the following text we will call the side that sends the data -
the transmitter and its counterparty - the receiver.

If one of the sides sends a data file longer than 255 bytes _(which is always in this task)_,
a window acknowledgment scheme with a fixed window size of
W = 2040 bytes and a timeout Tout = 100 ms is used.

The transmitter is trying to have just as many unacknowledged bytes of data stream
sent in the communication channel, as the window size. When communication starts,
it writes W bytes to the channel and waits for acknowledgment.
The receiver responds to all incoming packets by sending an acknowledgment packet
(packet with acknowledgment number set).
The acknowledgment number describes the sequential number of the expected byte
in the stream of received data, so each acknowledgment number confirms the receiving
of all data up to that sequential number (without it).
If the receiver receives out-of-order data,
it will remember that and send a acknowledgment number set after the last received byte
in the data stream without gaps.
Once the gaps are filled with the newly received data, the receiver shifts the
acknowledgment number to point to the last received byte in a continuous
stream of received data. Thus, out-of-order data is ultimately used,
but the receiver does not initially confirm it.
It always confirms only the received stream without gaps.

When the transmitting side receives a packet with such acknowledgment that reduces
the number of unconfirmed data in the outgoing stream,
it sends the next data so that there is again W unconfirmed bytes
in the channel (we say it slides the window).

The transmitter remembers the timestamp of sending the last packet (denoted as T).
If the server does not receive any new acknowledgment by time T + Tout,
which reduces the number of unconfirmed data, the transmitter sends W bytes
from the highest received acknowledgment number
(we say it sends the entire window).
It also sets T to the new value.

The transmitter always sends the maximum amount of data in one packet (255 bytes).
The exception is the last data packet, which may contain less data.

If the transmitter receives the same acknowledgment number 3 times in a row,
it immediately sends a packet with the maximum amount of data starting
from the received acknowledgment number and sets T to a new value.


### Connection termination

If the transmitter sends the entire file and has all the sent data
acknowledged, it closes the connection by setting the FIN flag.
This flag cannot be combined with the last data upload.
The receiver then also sends a FIN flag packet.

The connection is terminated on both sides when both parties that
have already sent a packet with the FIN flag set receive a packet
with the FIN flag set and a confirmation number with the same value as the sequence number.

If a packet with the same sequence number is repeatedly sent 20 times in a row,
the connection is interrupted, the client has to report a transmission error.
This also applies to termination of the connection when the FIN flag is sent.

### Commands

#### command 01h - foto of the surroundings

As soon as the probe sends the first packet with the SYN flag set,
it will immediately send the photo of the surroundings.
If the first packet (SYN) was lost, the connection expires after sending 20 identical
packets (the client requests a new connection by sending a new SYN packet).

The sent photo is in PNG format and only its content is sent,
not the file name or any other information.
Each photo sent is unique (the photos got from different connections are different).

#### command 02h - upload of new firmware

When the client receives the first packet with the SYN flag set from the server,
it begins to send the content of the firmware file.
No additional information, such as file name or length, is sent.


### Receiving a wrong packet

When a wrong packet is received, the receiver (both client and server) sends a RST packet. A wrong packet is a packet that:

- does not contain a valid connection ID and does not have the SYN flag set

- has no acknowledgment number in the interval _<seq - window size, seq>_ where seq is the transmitter sequence number

- has multiple flags set

- has SYN flag set and data field does not contain valid command (data length is not 1B and command is not 01h or 02h)

- has the FIN flag set and contains data

Be careful, sequential and acknowledgment numbers may overflow, which must not affect the communication.


### Examples of communication

[Examples of communication are at this page.](ExamplesOfCommunication.md)

## Network errors

Possible network errors:

- loss of any packet,

- duplication of any packet,

- swap of packets order,

- variable network delay.

The server emulates these errors.
It may happen that the server causes 20x the same packet to be lost
and the RST flag is sent and the connection is terminated.
This error is not a problem when submitting the task
(the transmission is repeated during the submission).


## Requirements

- the program must be stable and resistant to unexpected inputs

- transferred file (download and upload) must not be corrupted

- the program must be able to cope with the fact that UDP packets
are sometimes lost, duplicated or swapped

- the program should list at least basic information about its
state (e.g., sent and received commands or replies)

- the IP address or DNS name of the server is specified as a
parameter in the command line when the program is
started (i.e. not embedded in the source code), see the syntax below,

- the source text must be commented,
the author must be included in the header of all source texts

- any programming language can be used,
the only condition is the ability to present functionality in a network lab,

- it is recommended to write the code in one source file for easier uploading

- the program must receive command line parameters with the following syntax:

**Download foto** (command 01h): `./robot <server>`
Recived foto is saved in file foto.png.

**Upload firmware** (command 02h): `./robot <server> <firmware.bin>`

_<server>_ is name or IP address of the server and _<firmware>_ is a file with new firmware for probe.

Example of run: `java robot.Robot 81.25.17.115 /data/firmware.bin`


##  Testing

For testing, you can use a test image for Virtualbox.
Recommended for testing under Windows or MacOS.
For testing, the network adapter for the virtual machine need to be set
as a bridge adapter - this is useful if you are in a local network
where the virtual machine gets its own IP address.
If this is not possible, use Host-only option.
After booting, it is necessary to find out the assigned IP address of the virtual machine.
Then just run the test server using the command: *Run_server_for_homework_2*

Testing image contains client as binary executable file (could be run by command: "kareludp-clent").

Also UDP server running in the tester is available separately for linux users. Notes to its usage:

- Server could be run as: `./kareludp-server 1000 - foto.png firmware.bin`

where 1000 is process UID (any positive integer number),
under which server runs, foto.png is the path to the foto and firmware.bin is the firmware file.

- Or server could be run with the script *Run_server_for_homework_2*.


## For download

| file                                                      | link                          |
|-----------------------------------------------------------|-------------------------------|
| Reference solution - server + client (binaries for linux) | *kareludp-en.zip*             |
| Testing image for Virtualbox                              | *BI-PSI-Karel-UDP-en.ova.zip* |


## Deadline and submission

Homework code need to be uploaded to the submission server
[PSI bouda](https://bouda.fit.cvut.cz) and present to the teacher.

You can only submit a program that is able to successfully
download a photo (for submittion a successful download of a photo file is enough).

The task can be submitted at the day of the exam at latest.

## Points

You can get up to 8 points for the homework. Penalization:

- program can’t download photo: _cannot submit!_

- the program cannot perform firmware upload: -4

- the connection was not closed correctly: -1

- incorrectly implemented window protocol: depends on behaviour -1 to -4

- instability: -3

- low resistance to non-standard inputs: -3

- program errors that did not occur directly: depends on behaviour -1 to -5

- unclean source code: -1

- source code was not continuously uploaded to Bouda server: -5
